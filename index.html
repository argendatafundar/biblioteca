<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Biblioteca de Datasets</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root { --fg:#222; --bg:#fff; --muted:#666; --accent:#0a7; --border:#ddd; --error:#b00; }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif}
    header{padding:24px 16px;border-bottom:1px solid var(--border);max-width:1400px;margin:0 auto}
    header h1{margin:0 0 8px 0;font-size:24px}
    header p{margin:0;color:var(--muted)}
    header .brand{display:flex;align-items:center;gap:12px}
    header .brand .logo{height:56px;width:auto;display:block}
    main{max-width:1400px;margin:0 auto;padding:16px}
    .toolbar{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin-bottom:12px}
    .toolbar input[type="text"]{flex:1 1 260px;padding:8px 10px;border:1px solid var(--border);border-radius:6px}
    .toolbar .hint{font-size:12px;color:var(--muted)}
    .toolbar select, .toolbar button, .toolbar label{padding:8px 10px;border:1px solid var(--border);border-radius:6px;background:#fafafa}
    table{width:100%;border-collapse:collapse;table-layout:fixed}
    th,td{padding:8px 10px;border-bottom:1px solid var(--border);vertical-align:top;overflow-wrap:anywhere}
    th{background:#fafafa;text-align:left;position:sticky;top:0;z-index:1}
    .pagination{display:flex;gap:6px;align-items:center;flex-wrap:wrap;margin-top:12px}
    .pagination button{padding:6px 10px;border:1px solid var(--border);border-radius:6px;background:#fff;cursor:pointer}
    .pagination button.active{background:var(--accent);color:#fff;border-color:var(--accent)}
    .stats{font-size:12px;color:var(--muted)}
    .error{color:var(--error);font-size:12px}
    .sr{position:absolute;left:-10000px;top:auto;width:1px;height:1px;overflow:hidden}
    .nowrap{white-space:nowrap}
    code.k{background:#f4f4f4;border:1px solid #e6e6e6;border-radius:4px;padding:0 4px;font-family:ui-monospace,Menlo,Consolas,monospace}
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <img class="logo" src="assets/icon.png" alt="ArgendataFundar" href="#">
    </div>
  </header>
  <main>
    <main>
      <h1>Biblioteca de Datasets de Argendata</h1>
      <h2>Explorador de datasets de <a href="https://argendata.fund.ar/" target="_blank" rel="noopener">argendata.fund.ar</a>.</h2>
      <p>Buscador con soporte de expresiones regulares y tabla paginada.</p>
      <p>Filtrá por tópico, buscá por regex y paginá los resultados.</p>
      <p>Los datasets se encuentran en el repositorio de <a href="https://github.com/argendatafundar/data" target="_blank">argendatafundar/data</a>.</p>
      <p>Haciendo click podés ver el dataset y el gráfico correspondiente</p>

      <section class="toolbar" aria-label="Controles de búsqueda y paginación">
        <select id="categoryFilter" aria-label="Filtrar por categoría">
          <option value="">Todas las categorías</option>
        </select>
        <select id="topicFilter" aria-label="Filtrar por tópico">
          <option value="">Todos los tópicos</option>
        </select>
        <input id="q" type="text" placeholder="Buscar" aria-label="Buscar (regex)">
        <button id="searchBtn" type="button">Buscar</button>
        <span id="err" class="error" role="status" aria-live="polite"></span>
        <span class="stats" id="stats"></span>
      </section>

    <div style="overflow:auto; max-height:70vh; border:1px solid var(--border); border-radius:8px;">
      <table id="table" aria-label="Resultados">
        <colgroup>
          <col style="width:10%">
          <col style="width:9%">
          <col style="width:12%">
          <col style="width:12%">
          <col style="width:12%">
          <col style="width:16%">
          <col style="width:12%">
          <col style="width:14%">
        </colgroup>
        <thead id="thead"></thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <nav class="pagination" id="pager" aria-label="Paginación"></nav>
    <div style="display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-top:8px;">
      <label for="pageSize" style="font-size:14px;">Filas por página:</label>
      <select id="pageSize" aria-label="Filas por página" style="padding:8px 10px; border:1px solid var(--border); border-radius:6px; background:#fafafa">
        <option value="10">10</option>
        <option value="20" selected>20</option>
        <option value="25">25</option>
        <option value="50">50</option>
        <option value="100">100</option>
      </select>
    </div>
    <p class="hint">
      Sugerencia: usa patrones regex. Teclas rápidas: <code class="k">/</code> enfoca buscador, <code class="k">Enter</code> aplica.
    </p>
  </main>

  <script>
  ;(function(){
    const el = id => document.getElementById(id);
    const $q = el('q'), $pageSize = el('pageSize'), $err = el('err'), $stats = el('stats'), $searchBtn = el('searchBtn');
    const $topic = el('topicFilter'), $category = el('categoryFilter');
    const $thead = el('thead'), $tbody = el('tbody'), $pager = el('pager');
    let RAW = [];
    let FILTERED = [];
    let state = { page: 1, pageSize: 20, pattern: '', topic: '', category: '' };

    function textOf(v){
      if (v == null) return '';
      if (typeof v === 'object') return JSON.stringify(v);
      return String(v);
    }

    function buildRegex(pattern){
      try{
        return { re: new RegExp(pattern, 'i'), error: null };
      }catch(e){
        return { re: null, error: e.message };
      }
    }

    function getWebpage(src){
      if (!src) return '';
      if (Array.isArray(src)){
        for (const s of src){ if (s && s.webpage) return s.webpage; }
        return '';
      }
      if (typeof src === 'object'){ return src.webpage ?? ''; }
      return '';
    }

    
    const COLUMNS_FIXED = [
      { header: 'Categoría', getText: r => textOf(r.categoria) },
      { header: 'Tópico', getText: r => textOf(r.nombre_topico) },
      { header: 'Título gráfico', getText: r => textOf(r.titulo) },
      { header: 'Sub-título', getText: r => textOf(r.bajada) },
      { header: 'URL gráfico', getText: r => textOf(getWebpage(r.sources)), render: (r) => {
          const url = getWebpage(r.sources);
          if (!url) return document.createTextNode('');
          const a = document.createElement('a');
          a.href = url; a.textContent = url; a.target = '_blank'; a.rel = 'noopener';
          return a;
        }
      },
      { header: 'Dataset', getText: r => textOf(r.nombre_archivo), render: (r) => {
          const href = r.link_dataset || '';
          const name = r.nombre_archivo || '';
          if (!href || !name) return document.createTextNode(name || '');
          const a = document.createElement('a');
          a.href = href; a.textContent = name; a.target = '_blank'; a.rel = 'noopener';
          return a;
        }
      },
      { header: 'Fuente', getText: r => textOf(r.fuente) },
      { header: 'Nota', getText: r => textOf(r.nota) }
    ];

    function renderHeader(){
      $thead.innerHTML = '';
      const tr = document.createElement('tr');
      for (const c of COLUMNS_FIXED){
        const th = document.createElement('th');
        th.textContent = c.header;
        tr.appendChild(th);
      }
      $thead.appendChild(tr);
    }

    function renderBody(rows){
      $tbody.innerHTML = '';
      const frag = document.createDocumentFragment();
      for (const row of rows){
        const tr = document.createElement('tr');
        for (const c of COLUMNS_FIXED){
          const td = document.createElement('td');
          if (c.render){
            const node = c.render(row);
            td.appendChild(node);
          }else{
            td.textContent = c.getText(row);
          }
          tr.appendChild(td);
        }
        frag.appendChild(tr);
      }
      $tbody.appendChild(frag);
    }

    function renderPager(total, page, pageSize){
      $pager.innerHTML = '';
      const totalPages = Math.max(1, Math.ceil(total / pageSize));
      const btn = (label, target, disabled=false, active=false) => {
        const b = document.createElement('button');
        b.textContent = label;
        if (active) b.classList.add('active');
        if (disabled){ b.disabled = true; }
        else { b.addEventListener('click', () => { state.page = target; update(); }); }
        return b;
      };
      $pager.appendChild(btn('«', 1, page===1));
      $pager.appendChild(btn('‹', Math.max(1, page-1), page===1));

      const windowSize = 5;
      const start = Math.max(1, page - Math.floor(windowSize/2));
      const end = Math.min(totalPages, start + windowSize - 1);
      for (let p = Math.max(1, end - windowSize + 1); p <= end; p++){
        $pager.appendChild(btn(String(p), p, false, p===page));
      }

      $pager.appendChild(btn('›', Math.min(totalPages, page+1), page===totalPages));
      $pager.appendChild(btn('»', totalPages, page===totalPages));

      $stats.textContent = total === 0
        ? '0 resultados'
        : `Mostrando ${Math.min((page-1)*pageSize+1, total)}–${Math.min(page*pageSize, total)} de ${total}`;
    }

    function applyFilter(){
      // Filtrado por categoría y tópico
      let base = RAW.slice();
      if (state.category){
        base = base.filter(r => (r.categoria || '') === state.category);
      }
      if (state.topic){
        base = base.filter(r => (r.nombre_topico || r.topico || '') === state.topic);
      }

      // Filtrado por regex
      const pattern = state.pattern.trim();
      if (!pattern){
        $err.textContent = '';
        return base;
      }
      const { re, error } = buildRegex(pattern);
      if (error){
        $err.textContent = 'Regex inválida: ' + error;
        return base.slice(0, 0);
      }
      $err.textContent = '';
      return base.filter(row => {
        for (const c of COLUMNS_FIXED){
          if (re.test(c.getText(row))) return true;
        }
        return false;
      });
    }

    function update(){
      state.pageSize = parseInt($pageSize.value, 10);
      FILTERED = applyFilter();
      const total = FILTERED.length;
      const totalPages = Math.max(1, Math.ceil(total / state.pageSize));
      if (state.page > totalPages) state.page = totalPages;

      const start = (state.page - 1) * state.pageSize;
      const pageRows = FILTERED.slice(start, start + state.pageSize);

      renderHeader();
      renderBody(pageRows);
      renderPager(total, state.page, state.pageSize);
    }

    function updateTopicFilter(){
      let filteredData = RAW;
      if (state.category){
        filteredData = RAW.filter(r => (r.categoria || '') === state.category);
      }
      const topics = Array.from(new Set(filteredData.map(r => r.nombre_topico || r.topico).filter(Boolean))).sort();
      const currentTopic = state.topic;
      $topic.innerHTML = '<option value="">Todos los tópicos</option>' + topics.map(t => `<option value="${t}">${t}</option>`).join('');
      
      // Restaurar el tópico seleccionado si todavía existe en las opciones filtradas
      if (currentTopic && topics.includes(currentTopic)){
        $topic.value = currentTopic;
      } else {
        state.topic = '';
        $topic.value = '';
      }
    }

    async function loadData(){
      try{
        const res = await fetch('manifest.json', { cache: 'no-store' });
        if (!res.ok) throw new Error('manifest no disponible');
        const manifest = await res.json(); // { items: [...] }
        const items = Array.isArray(manifest.items) ? manifest.items : [];
        RAW = items.length ? items : [];
      }catch(_){
        RAW = [];
      }
      // Poblar opciones de categoría
      const categories = Array.from(new Set(RAW.map(r => r.categoria).filter(Boolean))).sort();
      $category.innerHTML = '<option value="">Todas las categorías</option>' + categories.map(c => `<option value="${c}">${c}</option>`).join('');
      
      // Poblar opciones de tópico inicialmente con todos los tópicos
      updateTopicFilter();
      
      $pageSize.value = String(state.pageSize);
      update();
    }

       // Eventos
       $q.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') { state.page = 1; state.pattern = $q.value; update(); }
    });
    $q.addEventListener('input', () => { state.pattern = $q.value; });
    $pageSize.addEventListener('change', () => { state.page = 1; update(); });
    $category.addEventListener('change', () => { 
      state.page = 1; 
      state.category = $category.value; 
      updateTopicFilter();
      update(); 
    });
    $topic.addEventListener('change', () => { state.page = 1; state.topic = $topic.value; update(); });
    $searchBtn.addEventListener('click', () => { state.page = 1; state.pattern = $q.value; update(); });

    loadData();
  })();
  </script>
</body>
</html>